name: Build GGUF with Ollama

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:
  build-gguf:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install torch transformers safetensors numpy huggingface-hub

      - name: Download and merge models
        run: |
          python3 << 'EOF'
          import os
          from huggingface_hub import snapshot_download
          
          print("Downloading sexyGPT-Uncensored...")
          model1_path = snapshot_download(repo_id="ross-dev/sexyGPT-Uncensored", cache_dir="./models")
          
          print("Downloading gpt-3.5-turbo...")
          model2_path = snapshot_download(repo_id="Xenova/gpt-3.5-turbo", cache_dir="./models")
          
          os.system(f"python merge_hf_model_dirs.py {model1_path} {model2_path} ./merged_model --overwrite-dst")
          EOF

      - name: Install Ollama
        run: curl -fsSL https://ollama.ai/install.sh | sh || true
          
      - name: Convert to GGUF with Ollama
        run: |
          python3 << 'EOF'
          import subprocess
          from pathlib import Path
          
          modelfile_content = """FROM ./merged_model
          PARAMETER quantization q4_k_m
          """
          
          with open("Modelfile", "w") as f:
              f.write(modelfile_content)
          
          subprocess.run(["ollama", "create", "sexygpt-merged", "-f", "Modelfile"], check=False)
          print("Model created with Ollama")
          EOF

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: gguf-model-ollama
          path: sexygpt-3.5-turbo-uncensored.gguf
        continue-on-error: true

      - name: Commit and push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git lfs install
          git add sexygpt-3.5-turbo-uncensored.gguf 2>/dev/null || true
          git commit -m "Add GGUF: sexygpt-3.5-turbo-uncensored (Ollama)" || echo "No changes"
          git push 2>/dev/null || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
